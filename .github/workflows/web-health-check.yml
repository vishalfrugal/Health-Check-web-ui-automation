name: Daily Selenium Web UI Automation

on:
  workflow_dispatch:
  schedule:
    - cron: '30 4 * * *'   # 10 AM IST daily

jobs:
  selenium-tests:
    runs-on: ubuntu-latest
    env:
      BASE_URL: "https://vishalfrugal.github.io/Health-Check-web-ui-automation"

    steps:
      # Step 1 — Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2 — Set up JDK and Maven
      - name: Set up JDK 22
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 22
          cache: maven

      # Step 3 — Verify Java and Maven
      - name: Verify tools
        run: |
          java -version
          mvn -v

      # Step 4 — Install Chrome
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Verify Chrome installation
        run: google-chrome --version

      # Step 5 — Install Allure CLI
      - name: Install Allure
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip
          curl -o allure.tgz -L https://repo.maven.apache.org/maven2/io/qameta/allure/allure-commandline/2.27.0/allure-commandline-2.27.0.tgz
          sudo tar -zxvf allure.tgz -C /opt/
          sudo ln -s /opt/allure-2.27.0/bin/allure /usr/bin/allure
          allure --version

      # Step 6 — Run Selenium Tests in headless mode
      - name: Run Selenium Tests
        run: mvn clean test -Dsurefire.suiteXmlFiles=testng.xml -Dselenium.browser=headless

      # Step 7 — Generate Allure Report
      - name: Generate Allure Report
        if: always()
        run: allure generate allure-results --clean -o allure-report

      # Step 8 — Upload Allure Report
      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report

      # Step 9 — Deploy Allure Report to GitHub Pages
      - name: Deploy Allure Report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report

      # Step 10 - Set deployment URL (unique per run)
      - name: Set Deployment URL
        if: always()
        run: | 
          echo "DEPLOYMENT_URL=${{ env.BASE_URL }}/${{ github.run_number }}/#" >> $GITHUB_ENV echo "Deployment URL: ${{ env.BASE_URL }}/${{ github.run_number }}/#"
          echo "Deployment URL: ${{ env.BASE_URL }}/${{ github.run_number }}/#"

      # Step 11 — Send Slack Notification
      - name: Send Slack Notification
        if: always()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: ${{ job.status }}
          SLACK_TITLE: "Selenium Automation Report"
          SLACK_MESSAGE: | 
            *Project:* ${{ github.repository }} 
            *Run ID:* ${{ github.run_number }} 
            *Status:* ${{ job.status }} 
            *Allure Report:* ${{ env.BASE_URL }}/${{ github.run_number }}/#